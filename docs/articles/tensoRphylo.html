<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="tensoRphylo">
<title>Using tensoRphylo • tensoRphylo</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.1.0/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.1.0/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.rawgit.com/afeld/bootstrap-toc/v1.0.1/dist/bootstrap-toc.min.js"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Using tensoRphylo">
<meta property="og:description" content="tensoRphylo">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">tensoRphylo</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.1</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item">
  <a class="nav-link" href="../articles/tensoRphylo.html">Quickstart</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/modelingframework.html">Models</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/dataformat.html">Input</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../articles/api.html">API</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-performance">Performance</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-performance">
    <a class="dropdown-item" href="../articles/validation.html">Validation</a>
    <a class="dropdown-item" href="../articles/comparison.html">Comparison</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav"></ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Using tensoRphylo</h1>
            
      
      
      <div class="d-none name"><code>tensoRphylo.Rmd</code></div>
    </div>

    
    
<p>Welcome to the quickstart guide for the <code>R</code> package
<code>tensoRphylo</code>, which is an <code>R</code> interface to the
<code>C++</code> library <code>TensorPhylo</code> (note the difference
in capitalization). This library is designed to compute probabilities of
trees (and discrete character data) under a general class of
state-dependent sampled-birth-death models. This general class of models
includes effectively all state-dependent (and state-independent)
sampled-birth-death models currently available in phylogenetics and
phylogenetic epidemiology.</p>
<p><code>TensorPhylo</code> is a not a <em>method</em>, and this package
is not intended for directly fitting models to data. Rather,
<code>TensorPhylo</code> is a high-performance implementation of a
<em>likelihood function</em>; it is up to you (or other package
developers!) to implement the machinery to fit models of interest using
this likelihood function. The <code>tensoRphylo</code> package uses
<code>Rcpp</code> to expose functionality from <code>TensorPhylo</code>
to <code>R</code> users. The purpose of this guide is to show
<code>R</code> users how to use <code>tensoRphylo</code> in their own
<code>R</code> code. It is also possible to use the
<code>TensorPhylo</code> library itself in <code>R</code> packages using
<code>Rcpp</code>, but that is a topic for another guide.</p>
<div class="section level2">
<h2 id="reading-in-data">Reading in data<a class="anchor" aria-label="anchor" href="#reading-in-data"></a>
</h2>
<p>Before we start using <code>tensoRphylo</code>, we need a tree and
some discrete character data. For more information about file formats,
see the <a href="articles/dataformat.html">Input Formats</a> page.</p>
<p>We read in a simple tree in <code><a href="https://rdrr.io/pkg/ape/man/read.tree.html" class="external-link">ape::phylo</a></code> format provided
in <code>inst/testdata</code>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># path to tree file</span>
<span class="va">tree_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testdata"</span>, <span class="st">"extant_tree.nex"</span>, 
                         package <span class="op">=</span> <span class="st">"tensoRphylo"</span><span class="op">)</span>

<span class="co"># read the tree</span>
<span class="va">tree</span> <span class="op">&lt;-</span> <span class="fu">ape</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/ape/man/read.nexus.html" class="external-link">read.nexus</a></span><span class="op">(</span><span class="va">tree_file</span><span class="op">)</span></code></pre></div>
<p>Now we read in some discrete-character data.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># path to data file</span>
<span class="va">data_file</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/system.file.html" class="external-link">system.file</a></span><span class="op">(</span><span class="st">"testdata"</span>, <span class="st">"extant_data.nex"</span>, 
                         package <span class="op">=</span> <span class="st">"tensoRphylo"</span><span class="op">)</span>

<span class="co"># read the data</span>
<span class="va">data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/readNexusData.html">readNexusData</a></span><span class="op">(</span><span class="va">data_file</span><span class="op">)</span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-a-tensorphylo-instance">Creating a <code>tensoRphylo</code> instance<a class="anchor" aria-label="anchor" href="#creating-a-tensorphylo-instance"></a>
</h2>
<p>Now it’s time to make a
<code><a href="../reference/TensorPhyloInstance.html">tensoRphylo::TensorPhyloInstance</a></code>. This <code>R</code>
object mediates all interactions between <code>R</code> and the
<code>TensorPhylo</code> backend library. To make a new instance, we
provide the tree and character data.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make a default tensorphylo instance</span>
<span class="va">tp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TensorPhyloInstance.html">makeTensorPhylo</a></span><span class="op">(</span><span class="va">tree</span>, <span class="va">data</span><span class="op">)</span></code></pre></div>
<p>(<code>makeTensorPhylo</code> will do some automatic checks to make
sure the tree and data are appropriately formatted. See <a href="articles/dataformat.html#conformity">Data Formats: Conformity</a>
for more details.)</p>
<p>You can also skip the <code>data</code> argument and instead just
provide a <code>num_states</code> argument. This will create a “blank”
data matrix with the <code>num_states</code> states (basically a
hidden-character model with <code>num_states</code> hidden states).</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make a default tensorphylo instance</span>
<span class="va">tp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TensorPhyloInstance.html">makeTensorPhylo</a></span><span class="op">(</span><span class="va">tree</span>, num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>The instance begins as a state-independent constant-rate Yule model
(<span class="math inline">\(\lambda = 1\)</span>, <span class="math inline">\(\mu = 0\)</span>, <span class="math inline">\(\rho
= 1\)</span>) for the tree, and a constant-rate <em>Mk</em> model for
the character data (transition rate <span class="math inline">\(\eta =
0.1\)</span>). We can already use the instance to compute a likelihood
under this model.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -55.60754</span></code></pre>
<p>Of course, we will generally not be using the default model, let
alone the default parameters! We’ll see how to specify models and
parameters next.</p>
</div>
<div class="section level2">
<h2 id="specifying-models-and-parameters">Specifying models and parameters<a class="anchor" aria-label="anchor" href="#specifying-models-and-parameters"></a>
</h2>
<p>Each model component (<em>e.g.</em>, the speciation rates, extinction
rates, transition rates, etc.) can be modified with specific models and
parameter values. In general, these processes may vary among character
states and/or time, but we’ll begin with the simple, constant-rate
models.</p>
<div class="section level3">
<h3 id="constant-rate-birth-death-models">Constant-rate birth-death models<a class="anchor" aria-label="anchor" href="#constant-rate-birth-death-models"></a>
</h3>
<p>The constant-rate birth-death model assumes that species arise with
rate <span class="math inline">\(\lambda\)</span>, go extinct with rate
<span class="math inline">\(\mu\)</span>, and are sampled at the present
with probability <span class="math inline">\(\rho\)</span>. To compute
the likelihood of the tree under such a model, we’ll create a
<code>TensorPhyloInstance</code> without character data (but the minimum
number of missing states):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># our initial instance</span>
<span class="va">tp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TensorPhyloInstance.html">makeTensorPhylo</a></span><span class="op">(</span><span class="va">tree</span>, num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></code></pre></div>
<p>We can now set our desired parameter values like so:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set some parameter values</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaConstant</span><span class="op">(</span><span class="fl">1.2</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setMuConstant</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setRhoPresent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -46.95763</span></code></pre>
<p>Here, “constant” indicates that the rates are the same over time and
among states; <code>setRhoPresent</code> specifies the sampling fraction
at the present (since other models may include sampling at multiple time
points). (Because the character data are all missing and the
diversification rates do not vary among discrete states, this is
effectively a constant-rate birth-death model.)</p>
<p>To compute a likelihood under a new parameter value (or set of
parameter values), don’t recreate the instance. Instead, just set the
parameters as we did above and recompute the likelihood:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set different parameter values</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaConstant</span><span class="op">(</span><span class="fl">0.9</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setMuConstant</span><span class="op">(</span><span class="fl">0.23</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -44.60947</span></code></pre>
</div>
<div class="section level3">
<h3 id="constant-rate-birth-death-models-with-character-data">Constant-rate birth-death models with character data<a class="anchor" aria-label="anchor" href="#constant-rate-birth-death-models-with-character-data"></a>
</h3>
<p>Now we’ll see how to model discrete character evolution. We begin by
recreating the <code>TensorPhyloInstance</code> with the binary
character data we loaded previously.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make the tensorphylo instance with character data</span>
<span class="va">tp</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/TensorPhyloInstance.html">makeTensorPhylo</a></span><span class="op">(</span><span class="va">tree</span>, <span class="va">data</span><span class="op">)</span></code></pre></div>
<p>We’ll again use a simple constant-rate birth-death model, but now
we’ll model the evolution of the discrete character as well. As before,
we’ll set some basic birth-death model parameters.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set diversification parameters</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaConstant</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setMuConstant</span><span class="op">(</span><span class="fl">0.1</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setRhoPresent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span></code></pre></div>
<p>We’ll also specify a very simple model of character evolution by
assuming transitions between states occur at the same rate. In this
case, the model has just one parameter, <span class="math inline">\(\eta\)</span>.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set transition parameters</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setEtaConstantEqual</span><span class="op">(</span><span class="fl">0.2</span><span class="op">)</span></code></pre></div>
<p>Here, “constant” indicates that rates are the same over time, and
“equal” indicates that the rates are equal among character states.</p>
<p>The likelihood is now the joint probability of the tree and character
data, given the specified parameters:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -48.85893</span></code></pre>
<p>Alternatively, we could allow rates of change to be different among
character states. We specify this type of model by first creating a
<code>tensoRphylo::RateMatrix</code> object, which describes the
instantaneous rate of change from state <em>i</em> (in the row) and
state <em>j</em> (in the column).</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># create an empty rate matrix with the appropriate number of states</span>
<span class="va">H</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeRateMatrix.html">makeRateMatrix</a></span><span class="op">(</span>num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="co"># specify the rate from state 1 to state 2</span>
<span class="va">H</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
<span class="va">H</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>

<span class="co"># print the matrix</span>
<span class="va">H</span></code></pre></div>
<pre><code><span class="co">## A rate matrix with 2 states. &lt;0x600001418240&gt;</span>
<span class="co">##     [-0.100, 0.100]</span>
<span class="co">##     [0.200, -0.200]</span></code></pre>
<p>Note that the rows of this matrix sum to zero; the diagonal elements
are automatically computed when we set the off-diagonal rates.</p>
<p>We can then provide this rate matrix to the
<code>TensorPhyloInstance</code></p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set the rate matrix</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setEtaConstantUnequal</span><span class="op">(</span><span class="va">H</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -50.212</span></code></pre>
<p>Here, <code>setEtaConstantUnequal</code> refers to the fact that
rates of change are unequal among character states.</p>
</div>
<div class="section level3">
<h3 id="state-dependent-models">State-dependent models<a class="anchor" aria-label="anchor" href="#state-dependent-models"></a>
</h3>
<p>Now, we want to specify a more complex model: one that allows the
diversification rates to vary among states. Let’s imagine we want to
allow the speciation rate, <span class="math inline">\(\lambda\)</span>,
to vary among two binary states. We can specify this model by creating a
vector of speciation rates (one per state):</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-dependent speciation rates</span>
<span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.5</span>, <span class="fl">1.0</span><span class="op">)</span>

<span class="co"># set the parameters</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaStateDependent</span><span class="op">(</span><span class="va">lambdas</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -54.54666</span></code></pre>
<p>Here, <code>setLambdaStateDependent</code> means that the speciation
rates depend on the character states.</p>
<p><strong>Note that we did not create a new
<code>TensorPhyloInstance</code>, so we are simply modifying our
previous model to now have state-dependent speciation rates.</strong>
Every time you call <code>setLambdaXYZ</code> (where <code>XYZ</code> is
some specific type of model), you are resetting the instance to use that
model and set of parameters—the previous speciation-rate model is
discarded. <em>All</em> other aspects of the model remain the same, so
this model currently assumes that extinction rates and sampling
fractions are the same for all character states.</p>
<p>We can specify state-dependent extinction rates and sampling
probabilities likewise:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-dependent extinction rates</span>
<span class="va">mus</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.05</span>, <span class="fl">0.1</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setMuStateDependent</span><span class="op">(</span><span class="va">mus</span><span class="op">)</span>

<span class="co"># specify the state-dependent sampling probabilities</span>
<span class="va">rhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setRhoPresentStateDependent</span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -54.01101</span></code></pre>
</div>
<div class="section level3">
<h3 id="time-dependent-models">Time-dependent models<a class="anchor" aria-label="anchor" href="#time-dependent-models"></a>
</h3>
<p>We can also let rates vary over time according to a discrete rate
function. Say we want to assume the speciation rate is the same among
character states, but changes at a particular time point, <span class="math inline">\(t\)</span>. We can specify such a model like
so:</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the rate-change time and the rates</span>
<span class="co"># NOTE: this undoes the state-dependent model we previously specified!</span>
<span class="va">lambda_change_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>
<span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span><span class="op">)</span>

<span class="co"># set the parameters</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaTimeDependent</span><span class="op">(</span><span class="va">lambda_change_times</span>, <span class="va">lambdas</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -50.9456</span></code></pre>
<p>In this case, time indicates how long ago the change occurred,
measured from the present (<span class="math inline">\(t =
0\)</span>).</p>
<p>There can be any number of rate-change times, but they must be
ordered in increasing age. There needs to be one more rate than rate
change time; the first rate is the rate between the present and the
first rate-change time, the second rate is the rate between the first
rate-change time and the next, etc. The last interval is open on the
right (to the past). For example, here is a model with three rates:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the rate-change time and the rates</span>
<span class="va">lambda_change_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span><span class="op">)</span>

<span class="co"># set the parameters</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaTimeDependent</span><span class="op">(</span><span class="va">lambda_change_times</span>, <span class="va">lambdas</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -52.21987</span></code></pre>
<p>When multiple parameters are time-dependent, they do not need to
share the same rate change times. For example, here is a model where
speciation and transition rates change at different times:</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the speciation rates</span>
<span class="va">lambda_change_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="fl">0.3</span><span class="op">)</span>

<span class="co"># specify the transition rates</span>
<span class="va">eta_change_times</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">etas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span>

<span class="co"># set the parameters</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaTimeDependent</span><span class="op">(</span><span class="va">lambda_change_times</span>, <span class="va">lambdas</span><span class="op">)</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setEtaTimeDependentEqual</span><span class="op">(</span><span class="va">eta_change_times</span>, <span class="va">etas</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -51.59954</span></code></pre>
<p>Transition rates can vary among states and over time, like so:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the transition-rate-change times</span>
<span class="va">eta_change_times</span> <span class="op">&lt;-</span> <span class="fl">5</span>

<span class="co"># specify transition rates in the first interval</span>
<span class="va">H_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeRateMatrix.html">makeRateMatrix</a></span><span class="op">(</span>num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">H_1</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>
<span class="va">H_1</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>

<span class="co"># specify transition rates in the second interval</span>
<span class="va">H_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeRateMatrix.html">makeRateMatrix</a></span><span class="op">(</span>num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">H_2</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>
<span class="va">H_2</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>

<span class="co"># make the vector of rate matrices</span>
<span class="va">Hs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">H_1</span>, <span class="va">H_2</span><span class="op">)</span>

<span class="co"># specify the transition rates</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setEtaTimeDependentUnequal</span><span class="op">(</span><span class="va">eta_change_times</span>, <span class="va">Hs</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -52.02416</span></code></pre>
</div>
<div class="section level3">
<h3 id="time-and-state-dependent-models">Time-and-state-dependent models<a class="anchor" aria-label="anchor" href="#time-and-state-dependent-models"></a>
</h3>
<p>It’s possible to specify time-and-state-dependent models in
<code>tensoRphylo</code>, that is, models where diversification rates
vary among states, but where the relationship between diversification
rates and states itself varies over time. This requires that we specify
a <em>matrix</em> of diversification rates, where the columns correspond
to the rates per state, and the rows correspond to time intervals.</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the speciation rates</span>
<span class="va">lambda_change_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">lambdas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">0</span>, nrow <span class="op">=</span> <span class="fl">3</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="co"># three time intervals, two states</span>
<span class="va">lambdas</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.2</span><span class="op">)</span> <span class="co"># speciation rates in the first interval</span>
<span class="va">lambdas</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span> <span class="co"># speciation rates in the second interval</span>
<span class="va">lambdas</span><span class="op">[</span><span class="fl">3</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.6</span><span class="op">)</span> <span class="co"># speciation rates in the third interval</span>

<span class="co"># set the parameters</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setLambdaTimeStateDependent</span><span class="op">(</span><span class="va">lambda_change_times</span>, <span class="va">lambdas</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -52.31829</span></code></pre>
</div>
<div class="section level3">
<h3 id="cladogenetic-models">Cladogenetic models<a class="anchor" aria-label="anchor" href="#cladogenetic-models"></a>
</h3>
<p><code>tensoRphylo</code> implements models where states may change at
speciation events, such that one or both of the descendant lineages can
have a different state than their ancestor, <em>i.e.</em>, where state
changes are <em>cladogenetic</em>. This is a common feature of
biogeographic and chromosomal models.</p>
<p>We specify these models with a three-dimensional array (loosely, a
“tensor”), <span class="math inline">\(\Omega\)</span>. The first
dimension is for the state of the ancestor, the second dimensions is for
the state of one descendant, and the third dimension is for the state of
the other descendant. The value in the <em>ijk</em><sup>th</sup> element
is the <em>probability</em> that a lineage in state <em>i</em> leaves
one descendant in state <em>j</em> and the other in state <em>k</em>,
given that there is a speciation event. We begin my making an empty
<code>tensoRphylo::CladoEvents</code> object, then filling in the events
with non-zero probability.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># make an empty cladogenetic array. </span>
<span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeCladogeneticEvents.html">makeCladogeneticEvents</a></span><span class="op">(</span>num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>

<span class="co"># print the empty array</span>
<span class="va">W</span></code></pre></div>
<pre><code><span class="co">## A sparse cladogenetic event array with 2 events. &lt;0x600001418220&gt;</span>
<span class="co">##     (ancestral state -&gt; one descendant state, other descendant state) = value</span>
<span class="co">##     (1 -&gt; 1, 1) = 1.000</span>
<span class="co">##     (2 -&gt; 2, 2) = 1.000</span></code></pre>
<p>Note that that this array already includes two events, which
correspond to both descendants having the same state as the ancestor;
for a given ancestral state, all possible combinations of descendant
states must sum to 1. Therefore, we initially populate this array such
that the <em>iii</em> event has a probability of 1; whenever you set a
value for an event with the <em>i</em><sup>th</sup> ancestral state,
that value is subtracted from the <em>iii</em> event.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify a few cladogenetic events</span>
<span class="va">W</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>
<span class="va">W</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.3</span>

<span class="co"># print the populated array</span>
<span class="va">W</span></code></pre></div>
<pre><code><span class="co">## A sparse cladogenetic event array with 6 events. &lt;0x600001418220&gt;</span>
<span class="co">##     (ancestral state -&gt; one descendant state, other descendant state) = value</span>
<span class="co">##     (1 -&gt; 1, 1) = 0.800</span>
<span class="co">##     (1 -&gt; 1, 2) = 0.100</span>
<span class="co">##     (1 -&gt; 2, 1) = 0.100</span>
<span class="co">##     (2 -&gt; 1, 2) = 0.150</span>
<span class="co">##     (2 -&gt; 2, 1) = 0.150</span>
<span class="co">##     (2 -&gt; 2, 2) = 0.700</span></code></pre>
<p>Note that, while we specified only three events, we’ve actually added
four events to the array. This is because we require the array to be
symmetrical for a given ancestral state: if we set <em>ijk</em> to one
value, we also need to specify <em>ikj</em> to the same value because we
do not distinguish between right and left descendants. Therefore, when
we set <code>W[1,1,2] &lt;- 0.2</code> we are actually setting
<code>W[1,1,2] &lt;- 0.1</code> and <code>W[1,2,1] &lt;- 0.1</code>: the
provided probability is divided in half between the two
indistinguishable alternatives.</p>
<p>Once we’ve created our cladogenetic array, we provide it to the
<code>TensorPhyloInstance</code> like so:</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set the cladogenetic array</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setOmegaConstant</span><span class="op">(</span><span class="va">W</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -52.39677</span></code></pre>
<p>We can also set time-dependent cladogenetic arrays.</p>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the cladogenetic-array-change times</span>
<span class="va">omega_change_times</span> <span class="op">&lt;-</span> <span class="fl">3</span>

<span class="co"># specify cladogenetic events in the first interval</span>
<span class="va">W_1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeCladogeneticEvents.html">makeCladogeneticEvents</a></span><span class="op">(</span>num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">W_1</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.2</span>
<span class="va">W_1</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.3</span>

<span class="co"># specify cladogenetic events in the second interval</span>
<span class="va">W_2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/makeCladogeneticEvents.html">makeCladogeneticEvents</a></span><span class="op">(</span>num_states <span class="op">=</span> <span class="fl">2</span><span class="op">)</span>
<span class="va">W_2</span><span class="op">[</span><span class="fl">1</span>,<span class="fl">1</span>,<span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.5</span>
<span class="va">W_2</span><span class="op">[</span><span class="fl">2</span>,<span class="fl">2</span>,<span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0.1</span>

<span class="co"># make the vector of rate matrices</span>
<span class="va">Ws</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">W_1</span>, <span class="va">W_2</span><span class="op">)</span>

<span class="co"># specify the transition rates</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setOmegaTimeDependent</span><span class="op">(</span><span class="va">omega_change_times</span>, <span class="va">Ws</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -52.00237</span></code></pre>
</div>
<div class="section level3">
<h3 id="models-with-mass-events">Models with mass events<a class="anchor" aria-label="anchor" href="#models-with-mass-events"></a>
</h3>
<p>The general modeling framework implemented in
<code>TensorPhylo</code> includes a “mass” equivalent for every type of
diversification event. These mass events occur at a given time and
affect each lineage alive at that time. In fact, we’ve already used a
mass event: sampling at the present, represented by <span class="math inline">\(\rho\)</span> in the birth-death model. These mass
events can be state-independent (each lineage experiences the same event
magnitude regardless of its state), or state-dependent (each lineage
experiences a different magnitude that depends on its state).</p>
<div class="section level4">
<h4 id="mass-sampling-events">Mass-sampling events<a class="anchor" aria-label="anchor" href="#mass-sampling-events"></a>
</h4>
<p>As we’ve seen previously, we set mass-sampling at the present like
so:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-independent sampling probabilities at the present</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setRhoPresent</span><span class="op">(</span><span class="fl">0.5</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -54.61207</span></code></pre>
<p>We can also specify state-dependent sampling at the present:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-dependent sampling probabilities at the present</span>
<span class="va">rhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span>

<span class="co"># set the sampling fraction</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setRhoPresentStateDependent</span><span class="op">(</span><span class="va">rhos</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -52.00237</span></code></pre>
<p>Sampling at the present is a special case of a mass-sampling event.
We can specify the same model a slightly different way by manually
specifying the time of the sampling event at the present:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-dependent sampling probabilities at the present</span>
<span class="va">sampling_times</span> <span class="op">&lt;-</span> <span class="fl">0</span>
<span class="va">rhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> 
<span class="va">rhos</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span> <span class="co"># sampling fraction at t = 0</span>

<span class="co"># set the sampling fraction</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setRhoStateDependent</span><span class="op">(</span><span class="va">sampling_times</span>, <span class="va">rhos</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -52.00237</span></code></pre>
<p>Notice that we are specifying the sampling fractions,
<code>rhos</code>, as a matrix: this is because this interface allows
for an arbitrary number of mass-sampling events at different times. The
rows in this matrix therefore correspond to the sampling fractions for
each state, while the columns correspond to the different sampling
times. For example, we can include an additional sampling event at time
<span class="math inline">\(t = 4\)</span> like so:</p>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-dependent sampling probabilities</span>
<span class="va">sampling_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">4</span><span class="op">)</span>
<span class="va">rhos</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">2</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> 
<span class="va">rhos</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.3</span>, <span class="fl">0.7</span><span class="op">)</span> <span class="co"># sampling fraction at t = 0</span>
<span class="va">rhos</span><span class="op">[</span><span class="fl">2</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.1</span>, <span class="fl">0.3</span><span class="op">)</span> <span class="co"># sampling fraction at t = 4</span>

<span class="co"># set the sampling fraction</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setRhoStateDependent</span><span class="op">(</span><span class="va">sampling_times</span>, <span class="va">rhos</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -54.29685</span></code></pre>
</div>
<div class="section level4">
<h4 id="mass-extinction-events">Mass-extinction events<a class="anchor" aria-label="anchor" href="#mass-extinction-events"></a>
</h4>
<p>Another type of mass-event involves each lineage at a given time
going extinct with some probability, which may or may not depend on its
state. We can specify these mass-extinction events similarly to how we
specified the mass-sampling events. Here is a state-independent
mass-extinction event at time <span class="math inline">\(t = 3\)</span>
where each lineage dies with probability <span class="math inline">\(p =
0.4\)</span>.</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-independent extinction probabilities</span>
<span class="va">mass_extinction_times</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">mass_extinction_magnitude</span> <span class="op">&lt;-</span> <span class="fl">0.4</span>

<span class="co"># set the mass-extinction events</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setGammaConstant</span><span class="op">(</span><span class="va">mass_extinction_times</span>, <span class="va">mass_extinction_magnitude</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -56.14386</span></code></pre>
<p>Again, state-dependent mass-extinction events are specified as a
matrix with rows that correspond to events, and columns that correspond
to state-dependent extinction probabilities:</p>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># specify the state-dependent extinction probabilities</span>
<span class="va">mass_extinction_times</span> <span class="op">&lt;-</span> <span class="fl">3</span>
<span class="va">gammas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fl">1</span>, ncol <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> 
<span class="va">gammas</span><span class="op">[</span><span class="fl">1</span>,<span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.2</span>, <span class="fl">0.8</span><span class="op">)</span> <span class="co"># extinction probabilities</span>

<span class="co"># set the sampling fraction</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">setGammaStateDependent</span><span class="op">(</span><span class="va">mass_extinction_times</span>, <span class="va">gammas</span><span class="op">)</span>

<span class="co"># compute the likelihood</span>
<span class="va">tp</span><span class="op">$</span><span class="fu">computeLogLikelihood</span><span class="op">(</span><span class="op">)</span></code></pre></div>
<pre><code><span class="co">## [1] -58.02865</span></code></pre>
</div>
</div>
</div>
<div class="section level2">
<h2 id="other-settings">Other settings<a class="anchor" aria-label="anchor" href="#other-settings"></a>
</h2>
<div class="section level3">
<h3 id="error-handling">Error handling<a class="anchor" aria-label="anchor" href="#error-handling"></a>
</h3>
<!-- By default, the `TensorPhyloInstance` will complain if you try to provide inappropriate parameter values, _e.g._, rate parameters less than zero, or probability parameters greater than 1 or less than zero: -->
<!-- ```{r error=TRUE} -->
<!-- tp$setLambdaConstant(-1.2) -->
<!-- tp$setRhoPresent(1.5) -->
<!-- ``` -->
<!-- (You can turn this behavior off if you want to do error handling on your own with `tp$setSafeMode(FALSE)`.) -->
<!-- We can now write a function of the parameters $\lambda$ and $\mu$, and estimate them by maximum likelihood. -->
<!-- ```{r} -->
<!-- constantRateLikelihood <- function(pars) { -->
<!--   # get the parameters -->
<!--   lambda <- pars[1] -->
<!--   mu     <- pars[2] -->
<!--   # make sure that parameters are not negative -->
<!--   if ( lambda < 0 || mu < 0 ) { -->
<!--     return(Inf) -->
<!--   } -->
<!--   # set the parameters -->
<!--   tp$setLambdaConstant(lambda) -->
<!--   tp$setMuConstant(mu) -->
<!--   # compute the likelihood -->
<!--   -tp$computeLogLikelihood() -->
<!-- } -->
<!-- # estimate the parameters by maximum likelihood -->
<!-- fit <- optim(c(1,0.5), constantRateLikelihood) -->
<!-- # report the MLEs -->
<!-- fit$par -->
<!-- ``` -->
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Michael R. May.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.3.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
